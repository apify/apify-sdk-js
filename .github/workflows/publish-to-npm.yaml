name: Publish to NPM

on:
    workflow_dispatch:
        inputs:
            ref:
                description: Git ref to publish (branch, tag, or commit SHA)
                required: true
                type: string
            tag:
                description: NPM dist-tag
                required: true
                type: choice
                default: latest
                options:
                    - latest
                    - beta

permissions:
    id-token: write # Required for OIDC
    contents: write # Required to push changelog/lock file updates

jobs:
    publish_to_npm:
        name: Publish to NPM
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6
              with:
                  ref: ${{ inputs.ref }}
                  token: ${{ secrets.APIFY_SERVICE_ACCOUNT_GITHUB_TOKEN }}
                  fetch-depth: 0
                  fetch-tags: true

            - name: Use Node.js 24
              uses: actions/setup-node@v6
              with:
                  node-version: 24
                  registry-url: 'https://registry.npmjs.org'
                  cache: 'npm'
                  cache-dependency-path: 'package-lock.json'

            - name: Update NPM
              run: npm install -g npm@latest

            - name: Install dependencies
              run: npm ci --force

            - name: Build module
              run: npm run build

            - name: Set beta version
              if: ${{ inputs.tag == 'beta' }}
              run: |
                  BASE_VERSION=$(node -p "require('./package.json').version")
                  BETA_VERSION="${BASE_VERSION}-beta.${GITHUB_RUN_NUMBER}"
                  npm version "$BETA_VERSION" --no-git-tag-version
                  node -p "require('./package.json').version"

            - name: Publish package (latest)
              if: ${{ inputs.tag == 'latest' }}
              run: |
                  npm publish --tag latest --access public --provenance

            - name: Publish package (beta -> dist-tag next)
              if: ${{ inputs.tag == 'beta' }}
              run: |
                  npm publish --tag next --access public --provenance
